<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node & GPU Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* 可以在这里添加一些基本的样式，或者保持 style.css 独立 */
        .icon-20 {
            width: 20px;
            height: 20px;
        }
        .icon-static {
            display: inline-block; /* 确保图片默认显示 */
        }
        .high-temp {
            color: #dc3545; /* Bootstrap danger color */
            font-weight: bold;
        }
        .high-utilization {
            color: #dc3545; /* Bootstrap danger color */
            font-weight: bold;
        }
        .card-header {
            background-color: var(--bs-body-bg); /* Use Bootstrap variable for theme compatibility */
            border-bottom: 1px solid var(--bs-border-color);
        }
        [data-bs-theme="dark"] .card-header {
            background-color: #343a40; /* Darker header for dark theme */
            color: #f8f9fa;
        }
        [data-bs-theme="light"] .card-header {
            background-color: #e9ecef; /* Lighter header for light theme */
            color: #212529;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/server.png" alt="Logo" class="d-inline-block align-text-top me-2 icon-20">
                Node & GPU Monitor
            </a>
            <span class="navbar-text text-light" id="last-updated-time">
                上次更新: N/A
            </span>
            <div class="action-group d-flex align-items-center">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-light dropdown-toggle" type="button" id="refreshIntervalDropdown" data-bs-toggle="dropdown" aria-expanded="false" data-bs-placement="bottom" title="设置数据刷新间隔">
                        刷新间隔: <span id="currentRefreshInterval">5 秒</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="refreshIntervalDropdown">
                        <li data-interval="5000"><a class="dropdown-item" href="#">5 秒</a></li>
                        <li data-interval="10000"><a class="dropdown-item" href="#">10 秒</a></li>
                        <li data-interval="15000"><a class="dropdown-item" href="#">15 秒</a></li>
                        <li data-interval="30000"><a class="dropdown-item" href="#">30 秒</a></li>
                        <li data-interval="60000"><a class="dropdown-item" href="#">1 分钟</a></li>
                    </ul>
                </div>

                <button class="btn btn-outline-light me-2" id="themeToggleBtn" data-bs-toggle="tooltip" data-bs-placement="bottom" title="切换亮/暗主题">
                    <i class="bi bi-sun-fill" id="themeIcon"></i>
                </button>

                <button class="btn btn-outline-light me-2" id="startAllBtn" onclick="startGuardAll(this)" data-bs-toggle="tooltip" data-bs-placement="bottom" title="启动所有节点的守护进程">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <img src="https://img.icons8.com/ios-filled/20/ffffff/play--v1.png" alt="Start All" class="me-1 icon-static icon-20">
                    一键启动所有守护
                </button>
                <button class="btn btn-outline-light me-2" id="stopAllBtn" onclick="stopGuardAll(this)" data-bs-toggle="tooltip" data-bs-placement="bottom" title="停止所有节点的守护进程">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    <img src="https://img.icons8.com/ios-filled/20/ffffff/stop.png" alt="Stop" class="me-1 icon-static icon-20">
                    一键停止所有守护
                </button>
                <button class="btn btn-outline-light" onclick="fetchNodesData()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="手动刷新节点数据">
                    <img src="https://img.icons8.com/ios-glyphs/30/ffffff/refresh.png" alt="Refresh Icon" class="me-1 icon-20">
                    刷新
                </button>
            </div>
        </div>
    </nav>

    <div class="progress rounded-0" style="height: 3px; display: none;" id="globalLoadingBar">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-12">
                <h2 class="mb-4">节点状态概览</h2>
                <div id="nodes-container" class="row">
                </div>
                <div id="no-nodes-message" class="col-12 text-center" style="display: none;">
                    <p class="fs-4 mt-5 text-muted">
                        <i class="bi bi-exclamation-circle-fill me-2"></i>
                        暂无节点数据可显示。<br>请检查后端服务或配置。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
    </div>

    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">操作确认</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmationModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmActionButton">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
        let REFRESH_INTERVAL = 5000; // 默认刷新间隔 5 秒
        let refreshTimer; // 用于存储 setInterval 的 ID
        let ALL_NODES_DATA = []; // Store the latest data for global button logic

        // 全局变量来存储待执行的回调和相关数据（用于模态框）
        let pendingActionCallback = null;
        let pendingActionButton = null; // 存储触发模态框的按钮

        // Function to show Bootstrap Toast messages with customized delay
        function showToast(message, type = 'success') {
            const toastContainer = $('.toast-container');
            const toastId = `toast-${Date.now()}`;
            let iconClass = '';
            let delay = 3000; // Default delay for success/info

            if (type === 'success') {
                iconClass = 'bi-check-circle-fill text-success';
                delay = 3000;
            } else if (type === 'error') {
                iconClass = 'bi-x-circle-fill text-danger';
                delay = 7000; // Longer delay for errors
            } else if (type === 'warning') {
                iconClass = 'bi-exclamation-triangle-fill text-warning';
                delay = 5000;
            } else { // info or default
                iconClass = 'bi-info-circle-fill text-info';
                delay = 3000;
            }

            const toastHtml = `
                <div class="toast align-items-center text-white bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi ${iconClass} me-2"></i> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            toastContainer.append(toastHtml);
            const toastEl = new bootstrap.Toast(document.getElementById(toastId), { delay: delay });
            toastEl.show();

            // Auto-remove toast from DOM after it's hidden
            document.getElementById(toastId).addEventListener('hidden.bs.toast', function () {
                $(this).remove();
            });
        }

        // 设置新的刷新间隔并重启计时器
        function setRefreshInterval(newInterval) {
            if (refreshTimer) { // 如果计时器存在，先清除它
                clearInterval(refreshTimer);
            }
            REFRESH_INTERVAL = newInterval;
            refreshTimer = setInterval(fetchNodesData, REFRESH_INTERVAL); // 启动新的计时器

            // 更新显示在按钮上的文本
            let intervalText = newInterval / 1000 + ' 秒';
            if (newInterval === 60000) {
                intervalText = '1 分钟';
            }
            $('#currentRefreshInterval').text(intervalText);
            showToast(`刷新间隔已设置为 ${intervalText}`, 'info');
        }


        function fetchNodesData() {
            const globalLoadingBar = $('#globalLoadingBar');
            const nodesContainer = $('#nodes-container');
            const noNodesMessage = $('#no-nodes-message'); // 获取无数据消息元素

            nodesContainer.empty(); // 清空现有内容 (所有节点卡片)
            noNodesMessage.hide(); // 初始隐藏“无数据”消息

            globalLoadingBar.show(); // 显示全局加载条

            $.getJSON('/api/nodes_data', function(data) {
                ALL_NODES_DATA = data; // 存储获取到的数据

                let allGuardsRunning = true;
                let allGuardsStopped = true;

                if (data.length === 0) {
                    // 如果没有节点数据，显示“无数据”消息
                    noNodesMessage.show();
                } else {
                    // 遍历节点数据并渲染卡片
                    data.forEach(node => {
                        const guardStatusClass = node.guard_running ? 'bg-success' : 'bg-danger';
                        const guardStatusText = node.guard_running ? '运行中' : '未运行';

                        // 从节点数据中获取阈值，如果不存在则使用默认值
                        const tempThreshold = node.thresholds && node.thresholds.temperature_high !== undefined ? node.thresholds.temperature_high : 75;
                        const utilThreshold = node.thresholds && node.thresholds.utilization_high !== undefined ? node.thresholds.utilization_high : 90;

                        const guardNeededClass = node.need_guard ? 'text-danger fw-bold' : 'text-success';
                        const guardNeededIcon = node.need_guard ? '<i class="bi bi-exclamation-triangle-fill me-1"></i>' : '';
                        const guardNeededText = node.need_guard ? '是' : '否';

                        const startBtnDisabled = node.guard_running ? 'disabled' : '';
                        const stopBtnDisabled = !node.guard_running ? 'disabled' : '';

                        if (!node.guard_running) {
                            allGuardsRunning = false;
                        }
                        if (node.guard_running) {
                            allGuardsStopped = false;
                        }

                        let gpuTableHtml = `
                            <table class="table table-striped table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>GPU</th>
                                        <th>温度 (°C)</th>
                                        <th>利用率 (%)</th>
                                        <th>显存 (MiB)</th>
                                        <th>功率 (W)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        node.gpus.forEach(gpu => {
                            const memUsage = gpu.memory_total > 0 ? ((gpu.memory_used / gpu.memory_total) * 100).toFixed(2) : 0;
                            const memColorClass = memUsage > 90 ? 'text-danger' : (memUsage > 70 ? 'text-warning' : '');

                            // Highlighting for temperature and utilization based on fetched thresholds
                            const tempColorClass = gpu.temperature > tempThreshold ? 'high-temp' : '';
                            const utilizationColorClass = gpu.utilization > utilThreshold ? 'high-utilization' : '';

                            gpuTableHtml += `
                                <tr>
                                    <td>GPU ${gpu.index}</td>
                                    <td class="${tempColorClass}">${gpu.temperature.toFixed(2)}</td>
                                    <td class="${utilizationColorClass}">${gpu.utilization.toFixed(2)}</td>
                                    <td class="${memColorClass}">${gpu.memory_used.toFixed(2)}/${gpu.memory_total.toFixed(2)} (${memUsage}%)</td>
                                    <td>${gpu.power_draw.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        gpuTableHtml += `
                                </tbody>
                            </table>
                        `;

                        const nodeCard = `
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h4 class="card-title mb-0">${node.hostname}</h4>
                                        <div>
                                            <span class="badge ${guardStatusClass} text-light me-2 fs-6">守护进程: ${guardStatusText}</span>
                                            <span class="badge bg-info text-dark fs-6 ${guardNeededClass}">${guardNeededIcon}需要守护: ${guardNeededText}</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        ${gpuTableHtml}
                                        <div class="d-flex justify-content-around mt-3">
                                            <button class="btn btn-success btn-sm" onclick="startGuardSingle('${node.hostname}', this)" ${startBtnDisabled} data-bs-toggle="tooltip" data-bs-placement="bottom" title="启动 ${node.hostname} 上的守护进程">
                                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                <img src="https://img.icons8.com/ios-filled/20/ffffff/play--v1.png" alt="Start" class="me-1 icon-static icon-20">
                                                启动守护
                                            </button>
                                            <button class="btn btn-danger btn-sm" onclick="stopGuardSingle('${node.hostname}', this)" ${stopBtnDisabled} data-bs-toggle="tooltip" data-bs-placement="bottom" title="停止 ${node.hostname} 上的守护进程">
                                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                <img src="https://img.icons8.com/ios-filled/20/ffffff/stop.png" alt="Stop" class="me-1 icon-static icon-20">
                                                停止守护
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        nodesContainer.append(nodeCard);
                    });
                    noNodesMessage.hide(); // 如果有数据，确保隐藏无数据消息
                }

                // 更新全局按钮的禁用状态
                $('#startAllBtn').prop('disabled', allGuardsRunning);
                $('#stopAllBtn').prop('disabled', allGuardsStopped);

                // 隐藏 Spinner 并显示图标（如果它们在加载开始时被显示）
                $('#startAllBtn .spinner-border').addClass('d-none');
                $('#startAllBtn .icon-static').removeClass('d-none');
                $('#stopAllBtn .spinner-border').addClass('d-none');
                $('#stopAllBtn .icon-static').removeClass('d-none');

                $('#last-updated-time').text('上次更新: ' + new Date().toLocaleTimeString());
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching nodes data: " + textStatus, errorThrown);
                showToast(`获取节点数据失败: ${textStatus}`, 'error');
                $('#last-updated-time').text('上次更新: 错误');
                nodesContainer.empty(); // 清空内容
                // 显示详细的错误消息，并确保显示
                noNodesMessage.html(`
                    <p class="fs-4 mt-5 text-danger">
                        <i class="bi bi-cloud-slash-fill me-2"></i>
                        无法连接到后端服务或获取数据失败。<br>请检查服务状态。
                    </p>
                `).show(); // 显示错误消息
            })
            .always(function() {
                globalLoadingBar.hide(); // 无论成功或失败，都隐藏全局加载条
                // 重新初始化 Tooltip，因为动态内容可能已添加
                initializeTooltips();
            });
        }

        // Helper function to show spinner and hide icon for a button
        function showLoading(button) {
            $(button).prop('disabled', true); // Disable button immediately
            $(button).find('.spinner-border').removeClass('d-none');
            $(button).find('.icon-static').addClass('d-none');
        }

        // Helper function to hide spinner and show icon (button state will be re-evaluated by fetchNodesData)
        function hideLoading(button) {
            $(button).find('.spinner-border').addClass('d-none');
            $(button).find('.icon-static').removeClass('d-none');
            // Button state will be re-evaluated by fetchNodesData() after refresh
        }

        // 显示自定义确认模态框
        function showConfirmationModal(message, callback, button) {
            $('#confirmationModalBody').text(message);
            pendingActionCallback = callback;
            pendingActionButton = button; // 保存按钮引用

            // 绑定确认按钮的点击事件
            $('#confirmActionButton').off('click').on('click', function() {
                if (pendingActionCallback) {
                    pendingActionCallback(); // 执行操作
                }
                $('#confirmationModal').modal('hide');
            });

            $('#confirmationModal').modal('show');
        }

        // Modification of your action functions to use the new modal
        function startGuardSingle(hostname, button) {
            if ($(button).is(':disabled')) {
                return;
            }
            const message = `确定要启动 ${hostname} 上的守护进程吗？`;
            showConfirmationModal(message, function() {
                showLoading(button); // 在确认后才显示加载状态
                $.ajax({
                    url: '/api/start_guard',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ hostnames: [hostname] }),
                    success: function(response) {
                        showToast(`启动 ${hostname} 守护进程成功！`);
                        fetchNodesData(); // Refresh data after action
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showToast(`启动 ${hostname} 守护进程失败: ${textStatus}`, 'error');
                        hideLoading(button); // 错误时恢复按钮
                    }
                });
            }, button);
        }

        function stopGuardSingle(hostname, button) {
            if ($(button).is(':disabled')) {
                return;
            }
            const message = `确定要停止 ${hostname} 上的守护进程吗？`;
            showConfirmationModal(message, function() {
                showLoading(button); // 在确认后才显示加载状态
                $.ajax({
                    url: '/api/stop_guard',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ hostnames: [hostname] }),
                    success: function(response) {
                        showToast(`停止 ${hostname} 守护进程成功！`);
                        fetchNodesData(); // Refresh data after action
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showToast(`停止 ${hostname} 守护进程失败: ${textStatus}`, 'error');
                        hideLoading(button);
                    }
                });
            }, button);
        }

        function startGuardAll(button) {
            if ($(button).is(':disabled')) {
                return;
            }
            const message = "确定要启动所有机器上的守护进程吗？";
            showConfirmationModal(message, function() {
                showLoading(button); // 在确认后才显示加载状态
                $.ajax({
                    url: '/api/start_guard',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ hostnames: [] }),
                    success: function(response) {
                        showToast("一键启动所有守护进程成功！");
                        fetchNodesData();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showToast("一键启动所有守护进程失败: " + textStatus, 'error');
                        hideLoading(button);
                    }
                });
            }, button);
        }

        function stopGuardAll(button) {
            if ($(button).is(':disabled')) {
                return;
            }
            const message = "确定要停止所有机器上的守护进程吗？";
            showConfirmationModal(message, function() {
                showLoading(button); // 在确认后才显示加载状态
                $.ajax({
                    url: '/api/stop_guard',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ hostnames: [] }),
                    success: function(response) {
                        showToast("一键停止所有守护进程成功！");
                        fetchNodesData();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        showToast("一键停止所有守护进程失败: " + textStatus, 'error');
                        hideLoading(button);
                    }
                });
            }, button);
        }


        // JavaScript for Theme Toggle
        function toggleTheme() {
            const htmlElement = document.documentElement;
            const currentTheme = htmlElement.getAttribute('data-bs-theme');
            const themeIcon = document.getElementById('themeIcon');

            if (currentTheme === 'dark') {
                htmlElement.setAttribute('data-bs-theme', 'light');
                if (themeIcon) {
                    themeIcon.classList.remove('bi-moon-fill');
                    themeIcon.classList.add('bi-sun-fill');
                }
                localStorage.setItem('theme', 'light');
            } else {
                htmlElement.setAttribute('data-bs-theme', 'dark');
                if (themeIcon) {
                    themeIcon.classList.remove('bi-sun-fill');
                    themeIcon.classList.add('bi-moon-fill');
                }
                localStorage.setItem('theme', 'dark');
            }
        }

        // Function to initialize Bootstrap Tooltips
        function initializeTooltips() {
            // Dispose existing tooltips to prevent duplicates when refreshing dynamic content
            var existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            existingTooltips.forEach(function (tooltipEl) {
                var tooltipInstance = bootstrap.Tooltip.getInstance(tooltipEl);
                if (tooltipInstance) {
                    tooltipInstance.dispose();
                }
            });

            // Initialize new tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        }

        // Initial fetch and set up refresh interval
        $(document).ready(function() {
            // Check for saved theme on load
            const savedTheme = localStorage.getItem('theme') || 'dark'; // 默认设置为暗色
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            const initialThemeIcon = document.getElementById('themeIcon');
            if (initialThemeIcon) { // Ensure element exists before manipulating
                if (savedTheme === 'dark') {
                    initialThemeIcon.classList.remove('bi-sun-fill');
                    initialThemeIcon.classList.add('bi-moon-fill');
                } else {
                    initialThemeIcon.classList.remove('bi-moon-fill');
                    initialThemeIcon.classList.add('bi-sun-fill');
                }
            }
            $('#themeToggleBtn').on('click', toggleTheme); // Attach event listener for theme toggle

            fetchNodesData();
            // 在页面加载时设置一次刷新间隔，并启动计时器
            setRefreshInterval(REFRESH_INTERVAL);

            // 监听下拉菜单点击事件，使用事件委托，直接在 li 元素上绑定
            $('.dropdown-menu').on('click', 'li', function(e) {
                e.preventDefault(); // 阻止默认的链接跳转行为 (如果点击的是a标签)
                e.stopPropagation(); // 阻止事件冒泡到上层元素，避免关闭下拉菜单

                const newInterval = $(this).data('interval');
                if (newInterval !== undefined) { // 检查data-interval属性是否存在
                    setRefreshInterval(newInterval);
                }
            });

            // Initialize tooltips on initial page load
            initializeTooltips();
        });
    </script>
</body>
</html>